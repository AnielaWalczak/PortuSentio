{% extends 'base.html' %}

{% block body %}
<div class="form-container">
    <h1>Selecione o produto</h1>
    <form method="POST" action="/relatório">
        <div class="form-group">
            <label for="product_id">Produto</label>
            <select name="product_id" id="product_id" required>
                <option value="" selected>Selecione um produto</option>
                {% for product in products %}
                <option value="{{ product.product_id }}">{{ product.product_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="De">De</label>
            <input type="date" name="date_from" id="De" required>
        </div>

        <div class="form-group">
            <label for="Até">Até</label>
            <input type="date" name="date_to" id="Até" required>
        </div>

        <button type="submit">Enviar</button>
    </form>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form');
        const fromDateInput = document.querySelector('input[name="date_from"]');
        const toDateInput = document.querySelector('input[name="date_to"]');
        const productSelect = document.querySelector('select[name="product_id"]');

        form.addEventListener('submit', async (e) => {
            const from = new Date(fromDateInput.value);
            const to = new Date(toDateInput.value);
            const diffDays = (to - from) / (1000 * 60 * 60 * 24);

            if (diffDays < 30) {
                e.preventDefault();
                alert('O intervalo de datas deve ser de pelo menos 30 dias.');
                return;
            }

            const product = productSelect.value;
            const response = await fetch(`/check-comments?product=${encodeURIComponent(product)}&from=${fromDateInput.value}&to=${toDateInput.value}`);
            const data = await response.json();

            if (!data || data.count < 30) {
                e.preventDefault();
                alert(`Existem apenas ${data.count} comentários neste período. O mínimo necessário é 30.`);
            }
        });
    });
</script>
{% endblock %}
