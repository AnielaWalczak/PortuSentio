import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.neighbors import KNeighborsClassifier
from sklearn.metrics import classification_report
import joblib

def preprocess_data(file_path, sample_size=None):
    print("Loading data...")
    df = pd.read_csv(file_path, low_memory=False)
    df = df.dropna(subset=['review_text', 'overall_rating'])

    df['label'] = df['overall_rating'].apply(
        lambda x: 2 if x >= 4 else 0 if x <= 2 else 1  # 0 = neg, 1 = neutral, 2 = pos
    )
    df['label'] = df['label'].astype(int)

    if sample_size:
        print(f"Sampling {sample_size} out of {len(df)} examples...")
        df = df.sample(n=sample_size, random_state=42)

    return df

def train_knn_model(df, k=5):
    print("Splitting dataset...")
    train_texts, val_texts, train_labels, val_labels = train_test_split(
        df['review_text'], df['label'], test_size=0.2, random_state=42, stratify=df['label']
    )

    print("Vectorizing with TF-IDF...")
    vectorizer = TfidfVectorizer(max_features=10000)
    X_train = vectorizer.fit_transform(train_texts)
    X_val = vectorizer.transform(val_texts)

    print(f"Training KNN with k={k}...")
    model = KNeighborsClassifier(n_neighbors=k, n_jobs=-1)  # use all CPU cores
    model.fit(X_train, train_labels)

    print("Evaluating...")
    preds = model.predict(X_val)
    print(classification_report(val_labels, preds))

    joblib.dump(model, 'knn_sentiment_model.joblib')
    joblib.dump(vectorizer, 'knn_tfidf_vectorizer.joblib')

    return model, vectorizer

def predict_comment(model, vectorizer, comment):
    X = vectorizer.transform([comment])
    prediction = model.predict(X)[0]
    return "Positivo" if prediction == 2 else "Neutro" if prediction == 1 else "Negativo"

if __name__ == "__main__":
    file_path = 'B2W-Reviews01.csv'

    # Set sample_size=None to use all data, or limit if too heavy
    df = preprocess_data(file_path, sample_size=None)  # RECOMMENDED for KNN

    model, vectorizer = train_knn_model(df, k=5)

    # Example
    example = "Serviço horrível, estou decepcionado."
    print(f"Komentarz: \"{example}\" ➝ {predict_comment(model, vectorizer, example)}")
